- name: Ensure local ~/.kube exists
  ansible.builtin.file:
    path: "{{ lookup('env','HOME') }}/.kube"
    state: directory
    mode: "0700"

- name: Backup kubeconfig
  ansible.builtin.copy:
    src: "{{ lookup('env','HOME') }}/.kube/config"
    dest: "{{ lookup('env','HOME') }}/.kube/config.bak"
    mode: "0600"

- name: Copy kubeconfig from server to local
  become: true
  ansible.builtin.fetch:
    src: /etc/rancher/k3s/k3s.yaml
    dest: "{{ lookup('env','HOME') }}/.kube/config"
    flat: true
  delegate_to: "{{ groups['k8_nodes'][0] }}"